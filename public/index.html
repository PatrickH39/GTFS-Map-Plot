<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <title>Vancouver Bus Map Overlay</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link
         rel="stylesheet"
         href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         />
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
      <style>
         html, body { margin:0; padding:0; height:100%; }
         #map { position: fixed;width:100%; height:100vh;background-color: white; pointer-events: none;z-index: 0; cursor: default;}
      </style>
   </head>
   <body>
      <div id="map"></div>
      <button id="toggle-geojson" class="floating-btn" style="
          position: absolute;
          bottom: 10px;
          right: 10px;
          z-index: 1000;
          background-color: white;
          border: 1px solid #ccc;
          padding: 8px 12px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: bold;
          transition: background-color 0.2s, color 0.2s;
      ">Map</button>
      <script>
         // Create map centered on Greater Vancouver coordinates
         const map = L.map('map', { zoomControl: false, attributionControl: false, scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false, dragging: false, keyboard: false, tap: false, boxZoom: false})
           .setView([49.2200, -123.1496], 11.5);
         map.off();
         
         let geojsonLayer;

         // Load Vancouver boundary and constrain map
        fetch('vancouver.geojson')
          .then(res => res.json())
          .then(data => {
            geojsonLayer = L.geoJSON(data, {
              style: { color:'#0078ff', weight:0.5, fill:true, fillOpacity:0.05 }
            }).addTo(map);

            const bounds = geojsonLayer.getBounds();
            map.setMinZoom(10);
            map.setMaxZoom(16);
          });

        toggleButton.addEventListener('click', () => {
          if (!geojsonLayer) return; // wait until the layer is loaded

          if (geojsonVisible) {
            map.removeLayer(geojsonLayer);
            toggleButton.textContent = 'GeoJSON OFF';
            toggleButton.classList.remove('active');
            toggleButton.classList.add('inactive');
          } else {
            geojsonLayer.addTo(map);
            toggleButton.textContent = 'GeoJSON ON';
            toggleButton.classList.remove('inactive');
            toggleButton.classList.add('active');
          }
          geojsonVisible = !geojsonVisible;
        });


         // Bus markers
         let markers = [];
         async function loadBuses() {
           try {
             const res = await fetch('/api/buses');
             const buses = await res.json();
         
             // Remove old markers
             markers.forEach(m => map.removeLayer(m));
             markers = [];
         
             // Add new bus markers
             buses.forEach(bus => {
               const marker = L.circleMarker([bus.lat, bus.lon], {
                 radius: 8,
                 color: null,
                 fillColor: '#0078ff',
                 fillOpacity: 0.15
               }).addTo(map);
               markers.push(marker);
             });
           } catch(err) {
             console.error('Failed to load buses', err);
           }
         }
         
         // Plane markers
         let planeMarkers = [];
         async function loadPlanes() {
           try {
             const res = await fetch('/api/planes');
             const planes = await res.json();
         
             // Remove old markers
             planeMarkers.forEach(m => map.removeLayer(m));
             planeMarkers = [];
         
             // Add new plane markers
             planes.forEach(plane => {
               const marker = L.circleMarker([plane.lat, plane.lon], {
                 radius: 8,
                 color: null,
                 fillColor: 'orange',
                 fillOpacity: 0.3
               }).addTo(map);
               planeMarkers.push(marker);
             });
           } catch(err) {
             console.error('Failed to load planes', err);
           }
         }

         // Ship markers
         let shipMarkers = [];
         async function loadShips() {
           try {
             const res = await fetch('/api/ships');
             const data = await res.json();

             // Ship array
             const ships = data.ships || [];

             // Remove old markers
             shipMarkers.forEach(m => map.removeLayer(m));
             shipMarkers = [];
         
             // Add new ship markers
             ships.forEach(ship => {
               const marker = L.circleMarker([ship.lat, ship.lon], {
                 radius: 8,
                 color: null,
                 fillColor: 'green',
                 fillOpacity: 0.15
               }).addTo(map);
               shipMarkers.push(marker);
             });
           } catch(err) {
             console.error('Failed to load ships', err);
           }
         }

         // Initial load + refresh every 15s
         loadBuses();
         loadPlanes();
         loadShips();
         setInterval(loadBuses, 15000);
         setInterval(loadPlanes, 15000);
         setInterval(loadShips, 15000);
      </script>
   </body>
</html>